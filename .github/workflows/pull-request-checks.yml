name: Pull Request Checks

on:
  pull_request:
    branches: [ main ]
    types: [opened, reopened, synchronize]
    paths:
      - 'api/**'
      - 'frontend/**'
      - 'cdk/**'
      - 'scraper/**'
      - 'prisma/**'
      - '.github/workflows/**'
      - '!**.md'

jobs:
  check-changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      api: ${{ steps.filter.outputs.api }}
      frontend: ${{ steps.filter.outputs.frontend }}
      prisma: ${{ steps.filter.outputs.prisma }}
      scraper: ${{ steps.filter.outputs.scraper }}
      cdk: ${{ steps.filter.outputs.cdk }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'api/**'
            frontend:
              - 'frontend/**'
            prisma:
              - 'prisma/**'
            scraper:
              - 'scraper/**'
            cdk:
              - 'cdk/**'

  prisma:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.prisma == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '23'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint -w prisma

  api:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.api == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '23'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint -w api
      - run: npm test -w api

  frontend:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '23'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint -w frontend
      - run: npm test -w frontend

  scraper:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.scraper == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '23'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint -w scraper

  cdk:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.cdk == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '23'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint -w cdk